---
    title: "index"
author: "Alex Fennell"
date: "4/10/2022"
output: 
    html_document:
    toc: true
self_contained: true
github_document:
    toc: true
---
    
```{r libraries}
#library(randomForest)
#library(e1071)
#library(doParallel)
#library(parallel)
library(caret)
library(dplyr)
```


```{r data loadin}
fileurl<-"https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
if (!file.exists("fittrain.csv")){
    download.file(fileurl,"fittrain.csv",method="curl")
}
fileurl<-"https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
if (!file.exists("fittest.csv")){
    download.file(fileurl,"fittest.csv",method="curl")
}
fit_train<-read.csv("fittrain.csv",stringsAsFactors = FALSE,na.strings = c("NA",""))

fit_test<-read.csv("fittest.csv",na.strings = c("NA",""))

```

```{r unique values}
uniq<-apply(fit_train,2,unique)
#lapply(uniq,head)
```


```{r examine missing data}
colSums(is.na(fit_train))
```

Given a good number of these variables are columns of missing values, I will go 
ahead and remove these.

```{r remove missing values}
threshold=.95
trainfilt<-fit_train[,colSums(is.na(fit_train))<(nrow(fit_train)*threshold)]
testfilt<-fit_test[,colSums(is.na(fit_test))==(nrow(fit_train)*threshold)]

```

Remove columns that contain time series data. I will only be using the data from the
accelerometers.

```{r remove timeseries data}
trainfilt<-trainfilt[,-c(1,2,3,4,5,6,7)]
testfilt<-testfilt[,-c(1,2,3,4,5,6,7)]

trainfilt$classe<-as.factor(trainfilt$classe)
```

```{r prepare data for modelling}
samp<-createDataPartition(y=trainfilt$classe,p=.8,list = FALSE)
training<-trainfilt[samp,]
validation<-trainfilt[-samp,]
```


```{r random forest model fit,cache=TRUE}
library(randomForest)
library(e1071)
library(parallel)
library(MLmetrics)
library(foreach)
library(doParallel)
cluster<-makeCluster(detectCores()-6) # leave some cores to do other things
registerDoParallel(cluster)

control<-trainControl(method='repeatedcv',
                      number=10,
                      repeats = 3,
                      classProbs = TRUE,
                      summaryFunction = multiClassSummary,
                      allowParallel = TRUE,
                      savePredictions = TRUE,
                      search='random',
                      verboseIter = TRUE)
trainpre<-preProcess(training,method=c('center','scale','pca'),thresh=.95)
trainpca<-predict(trainpre,training)


    rfmod<-train(classe~.,
                 data=trainpca,
                 method='rf',
                 ntree=250,
                 tuneLength=10,
                 verbose=TRUE,
                 metric='Accuracy',
                 trControl=control)

stopCluster(cluster)
registerDoSEQ()

```


```{r}
library('gbm')

control<-trainControl(method='cv',
                      number=10,
                      classProbs = TRUE,
                      summaryFunction = multiClassSummary,
                      savePredictions = TRUE,
                      search = "random")

gbmmod<-train(classe~.,
             data=trainpca,
             method='gbm',
             tuneLength=5,
             trControl=control)  

```


