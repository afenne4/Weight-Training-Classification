---
title: "Weight Lifting Analysis"
author: "Alex Fennell"
output: 
    html_document:
    toc: true
self_contained: true
github_document:
    toc: true
---
# Synopsis
The goal of this project is to correctly classify the quality of physical activity an individual
carried out based on accelerometer collected from the belt, forearm, arm, and dumbell.
There were 5 different ways in which the exercise was carried out. It was done either 
exactly according to the specification (Class A), throwing the elbows to the front (Class B),
lifting the dumbbell only halfway (Class C), lowering the dumbbell only halfway (Class D) 
and throwing the hips to the front (Class E). Class A is the correct manner in which
the exercise should be carried out, while the other classes are common errors. 
Using the accelerometer data I was able to create a random forest model that classified
this inoformation into the 5 desired classes with 98 percent accuracy.


```{r libraries,message=FALSE,warning=FALSE}
library(Hmisc)
library(vip)
library(dplyr)
library(randomForest)
library(e1071)
library(parallel)
library(MLmetrics)
library(foreach)
library(doParallel)
library(caret)
```

# Read in the Data

```{r data loading}
#train data location
fileurl<-"https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
if (!file.exists("fittrain.csv")){
    download.file(fileurl,"fittrain.csv",method="curl")
}
#test data location
fileurl<-"https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
if (!file.exists("fittest.csv")){
    download.file(fileurl,"fittest.csv",method="curl")
}

# The data sets had many entries that were spaces ("") and thus I specified these
# to be missing values (NA)
fit_train<-read.csv("fittrain.csv",na.strings = c("NA",""))
fit_test<-read.csv("fittest.csv",na.strings = c("NA",""))
```

# Assessing missing data
The first thing I want to do is assess the amount of missing data, so I know if there
are certain predictors I should remove, or I should implement an imputation technique.

```{r examine missing data}
colSums(is.na(fit_train))
```

Given a good number of these predictors are columns of missing values, I will go 
ahead and remove any predictor that is more than 95% missing values.

## Removing Missing Values

```{r remove missing values}
threshold=.95
trainfilt<-fit_train[,colSums(is.na(fit_train))<(nrow(fit_train)*threshold)]
testfilt<-fit_test[,colSums(is.na(fit_test))<(nrow(fit_test)*threshold)]
```

## Keeping accelerometer data
I am only interested in data from the accelerometers, so I will remove columns that contain other information.

```{r remove timeseries data}
trainfilt<-trainfilt[,-c(1,2,3,4,5,6,7)]
testfilt<-testfilt[,-c(1,2,3,4,5,6,7)]

trainfilt$classe<-as.factor(trainfilt$classe)
```

## Correlated Predictors
The next step in understanding the data is to look at correlations among
the predictors. If variables are highly related to each other, it may
be worthwhile to remove them or do some dimensionality reduction such
as PCA. I use a correlation of .75 here so as to only examine the most
highly correlated predictors.

```{r Find multicolinearity}
cormat<-trainfilt%>%
    select_if(is.numeric)%>%
    as.matrix()%>%
    rcorr(type='spearman')
highcor<-findCorrelation(cormat$r,cutoff = 0.75)
colnames(cormat$r[highcor,highcor])
```

It is not surprising that there are many correlated predictors given
that these are complex movements that require coordination from many
parts of the body. Given this, it seems inappropriate to remove
variables. Therefore I will go forward with a PCA technique in order to
reduce the dimensionality of the data while still retaining the most
informative aspects of the data.

## Near Zero Variance


```{r determine near zero variance}
nsv<-nearZeroVar(trainfilt,saveMetrics = TRUE)
sum(nsv$zeroVar==TRUE)
sum(nsv$nzv==TRUE)

```

```{r prepare data for modelling}
samp<-createDataPartition(y=trainfilt$classe,p=.8,list = FALSE)
training<-trainfilt[samp,]
validation<-trainfilt[-samp,]
```


```{r random forest model fit,cache=TRUE}

cluster<-makeCluster(detectCores()-6) # leave some cores to do other things
registerDoParallel(cluster)

control<-trainControl(method='repeatedcv',
                      number=10,
                      repeats = 3,
                      classProbs = TRUE,
                      summaryFunction = multiClassSummary,
                      allowParallel = TRUE,
                      savePredictions = TRUE,
                      search='random',
                      verboseIter = TRUE)
trainpre<-preProcess(training,method=c('center','scale','pca'),thresh=.95)
trainpca<-predict(trainpre,training)
valpca<-predict(trainpre,validation)
testpca<-predict(trainpre,testfilt)

testpca<-predict(trainpre,test)
    rfmod<-train(classe~.,
                 data=trainpca,
                 method='rf',
                 ntree=250,
                 tuneLength=10,
                 verbose=TRUE,
                 metric='Accuracy',
                 trControl=control)

stopCluster(cluster)
registerDoSEQ()
```

```{r vip plot}
vip(rfmod)
```

```{r examination of pc 15}
a<-head(sort(trainpre$rotation[,15]),5)
b<-head(sort(trainpre$rotation[,15],decreasing=TRUE),5)
data.frame(PCAmag=c(a,b))
```

```{r confusion matrix cross val holdout set}
confusionMatrix(rfmod)
```


```{r confusion matrix validation data set}
confusionMatrix(predict(rfmod,valpca),valpca$classe)
```



```{r model predictions test set}
rfpred<-predict(rfmod,testpca)
rfpred
```